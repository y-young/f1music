# 使用及评选流程

-   配置文件：`config/music.php`
-   前端路由文件：`react/src/pages/router.js`
-   前端结果页面文件：`react/src/routes/Result.js`

生产环境修改 `.env` 或 `config/` 后需要执行 `php artisan config:cache` 更新缓存。

## 后台管理系统

-   将管理员学号填写到配置文件中的 `admin` 数组中，将审核员学号填写到 `censor` 数组中
-   进入方式：先在前台通过正常方式登录，然后将页面地址修改为 `域名/manage`
-   管理员拥有所有操作权限，审核员无法彻底删除歌曲、访问投票结果页面和数据统计页面
-   如果没有后台管理权限则页面显示 404，如没有后台某些操作权限则返回 403

## 上传阶段

配置文件：

```
openUpload: true
openVote: false
openDownload: false
```

开放上传前**必须**清空 `songs` 和 `files` 数据表

1. 将上一年修改过（如果有）的前端路由文件恢复原状，详见前端路由文件中“评选阶段使用”部分注释
2. 将首页默认激活的选项卡改为“上传说明”，详见 `react/src/routes/Home.js` 注释，重新编译
3. 测试上传功能
4. 清空相关数据表
5. 修改配置文件，开放上传
6. 如果决定上传与审核同时进行，切记开放上传阶段**不得**彻底删除曲目，以免影响上传限制数的统计
7. 收集上传阶段同学们反馈的问题并进行处理

## 审核阶段

配置文件：

```
openUpload: false
openVote: false
openDownload: false
```

开始审核前**必须**备份 `songs` 和 `files` 数据表以及 `storage/app/uploads` 目录

1. 修改配置文件，关闭上传
2. 初审剔除必定不符合硬性规定的曲目，执行彻底删除操作
3. 二次筛选剔除直观听感不佳（如不符合所在时段要求、容易腻烦）的曲目，执行普通删除操作
4. 对每一时段印象较深的曲目进行记录，听完全曲，确保满足要求（1、2 可不听完全曲）
5. 复查回收站，恢复误判曲目，彻底删除确定要剔除的曲目
6. 讨论斟酌，对每一时段精选出 8-12 首曲目，这些曲目须经过全曲审查
7. 将曲目列表及音频文件提交给音乐组老师审核（可以不必写出曲目名称，但需按时段分类）
8. 听取音乐组老师建议，保留原样或进行调整
9. 删除回收站所有曲目，备份相关数据表及目录，准备进入投票阶段

注；额外要求及提示见后台首页

## 投票阶段

配置文件：

```
openUpload: false
openVote: true
openDownload: false
```

开放投票前**必须**清空 `orders`、`votes` 和 `reports` 数据表，删除回收站所有曲目（可使用命令 `php artisan music:clear_orders` ）

1. 建议将首页默认激活的选项卡改为“投票说明”，详见 `react/src/routes/Home.js` 中注释，重新编译
2. 测试投票功能
3. 清空相关数据表
4. 修改配置文件，开放投票
5. 收集投票阶段同学们反馈的问题并进行处理

## 统计阶段

配置文件：

```
openUpload: false
openVote: false
openDownload: false
```

投票结束后**必须**备份 `votes` 数据表

1. 修改配置文件，关闭投票
2. 备份相关数据表，保存投票结果（如截图），访问 `api/votes/analyze` 可查看更详细的统计结果
3. 将投票结果及音频文件提交音乐组老师进行审核，沟通交流并听取建议，尽量维持原投票结果，必要时作出调整并重新提交审核
4. 根据需要对音频文件进行处理
5. 确定当选曲目后填写并打印“校园音乐更换申请表”，经过社长、社团指导老师、德育处、团委签字批准后连同音频文件提交信息中心进行更换

## 公布结果

配置文件：

```
openUpload: false
openVote: false
openDownload: true
```

1. 使用后台“投票结果”页面的“生成结果”按钮生成投票结果，将输入框中的内容**原封不动**地赋给前端结果页面文件中的 `const rank`，修改后的结果应如 `const rank = [{}, {}, ...];`
2. 使用网易云音乐建立当选歌曲的歌单，记下歌单 ID，填写 `Result.js` 中歌单地址，如`http://music.163.com/playlist/1234567890`，并且修改配置文件中的 `playlist` 为歌单 ID
3. 修改前端路由文件，详见文件中“结果公布阶段使用”部分注释
4. 重新编译前端 css 及 js 文件：`cd react && npm run build`
5. 修改配置文件，公布结果
